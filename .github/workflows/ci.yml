name: Android Build CI

on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
    branches:
      - main

jobs:
  build-android:
    name: Build Android Native
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository and Submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: liberica
          cache: gradle

      - name: Generate Libs
        run: |
          ./gradlew imgui-binding:generateLibs -Denvs=androidaarch64 -Dlocal
          
      - name: Modify Android.mk with Optimizations
        run: |
          cd imgui-binding/build/jni
          
          # 备份原文件
          cp Android.mk Android.mk.bak
          
          # 添加优化标志 - 使用更可靠的方法
          sed -i 's/LOCAL_CFLAGS := \(.*\)/LOCAL_CFLAGS := \1 -O3 -flto -mllvm -polly -w -fpermissive -D__ANDROID__/' Android.mk
          
          # 检查是否已经有APP_STL，没有则添加
          if ! grep -q "APP_STL" Android.mk; then
            echo "APP_STL := c++_static" >> Android.mk
          fi
          
          # 添加链接器标志
          sed -i '/LOCAL_LDFLAGS/d' Android.mk  # 删除现有行
          sed -i '/include $(CLEAR_VARS)/a LOCAL_LDFLAGS := -flto -lc++_static -lc++abi -lc -lm -llog' Android.mk
          
          # 显示修改后的文件
          echo "=== Modified Android.mk ==="
          cat Android.mk
          
      - name: Build with NDK
        run: |
          cd imgui-binding/build/jni
          
          # 确保NDK环境变量
          if [ -z "$ANDROID_NDK_LATEST_HOME" ]; then
            echo "Error: ANDROID_NDK_LATEST_HOME not set"
            exit 1
          fi
          
          # 使用ndk-build构建
          ${ANDROID_NDK_LATEST_HOME}/ndk-build -j4 APP_PLATFORM=android-24 APP_ABI=arm64-v8a
          
      - name: Verify Build Output
        run: |
          echo "=== Build Output ==="
          find imgui-binding/build/libs -name "*.so" -type f | while read sofile; do
            echo "Found: $sofile"
            ls -la "$sofile"
            # 检查是否包含我们的优化标志（可选）
            ${ANDROID_NDK_LATEST_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf -p .comment "$sofile" 2>/dev/null || true
          done
          
          # 创建输出目录
          mkdir -p /tmp/android-build
          cp $(find imgui-binding/build/libs -name "*.so" -type f) /tmp/android-build/ 2>/dev/null || true
          
      - name: Upload Android Native Library
        uses: actions/upload-artifact@v4
        with:
          name: android-native-library
          path: /tmp/android-build/
          retention-days: 30
          if-no-files-found: error
          
      - name: Upload Full Build (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build-full
          path: |
            imgui-binding/build/libs/
            imgui-binding/build/jni/Android.mk
            imgui-binding/build/jni/obj/
          retention-days: 7
